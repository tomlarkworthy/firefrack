functions:            #reusable boolean functions
  - isLoggedIn():      auth.username !== null

schema:
  definitions:
    mem:
      type: object
      properties:
        last_access: {type: number}
      ~$cell:
        type: number
        constraint: next.parent()['last_access'] + '' == $cell

    program:
      type: object
      $line:
        type: string

    machine:
      type: object
      properties:
        program_loc: {type: string}
        data:    {$ref: "#/definitions/mem"}
        input:   {$ref: "#/definitions/mem"}
        output:  {$ref: "#/definitions/mem"}
        pc:      {type: number}

      constraint:
        (
          root[prev.program_loc][prev.pc + ''] == '>' &&
          next.pc == prev.pc + 1 &&
          next.data.index == prev.data.index + 1
        ) ||
        (
          root[prev.program_loc][prev.pc + ''] == '<' &&
          next.pc == prev.pc + 1 &&
          next.data.index == prev.data.index - 1
        ) ||
        (
          root[prev.program_loc][prev.pc + ''] == '+' &&
          next.pc == prev.pc + 1 &&
          next.data.value == prev.data.value + 1
        ) ||
        (
          root[prev.program_loc][prev.pc + ''] == '-' &&
          next.pc == prev.pc + 1 &&
          next.data.value == prev.data.value - 1
        )||
        (
          root[prev.program_loc][prev.pc + ''] == ',' &&
          next.pc == prev.pc + 1 &&
          next.data.value == prev.input.value &&
          next.input.index== prev.input.index + 1
        )||
        (
          root[prev.program_loc][prev.pc + ''] == '.' &&
          next.pc == prev.pc + 1 &&
          next.output.index== prev.output.index + 1
        )||
        (
          root[prev.program_loc][prev.pc + ''].isNumber() &&
          root[prev.program_loc][prev.pc + ''] > 0 &&
          next.data.value == 100 &&
          next.pc == root[prev.program_loc][prev.pc + '']
        )||
        (
          root[prev.program_loc][prev.pc + ''].isNumber() &&
          root[prev.program_loc][prev.pc + ''] > 0 &&
          next.data.value != 100 &&
          next.pc == prev.pc + 1
        )||
        (
          root[prev.program_loc][prev.pc + ''].isNumber() &&
          root[prev.program_loc][prev.pc + ''] < 0 &&
          next.data.value != 100 &&
          next.pc == -root[prev.program_loc][prev.pc + '']
        )||
        (
          root[prev.program_loc][prev.pc + ''].isNumber() &&
          root[prev.program_loc][prev.pc + ''] < 0 &&
          next.data.value == 100 &&
          next.pc == prev.pc + 1
        )

      additionalProperties: false   #prevent spurious data being part of a message


  type: object
  properties:
    program: {$ref: "#/definitions/program"}
    machine: {$ref: "#/definitions/machine"}

    test_mem: {$ref: "#/definitions/mem"}





access:
  - location: /
    write:    true
    read:     true
